name: Deploy and Migrate

on:
  push:
    branches: [main]

jobs:
  migrate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: Force IPv4 Connection
        id: ipv4
        run: |
          DB_HOST="db.${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co"
          IPV4_HOST=$(dig +short A $DB_HOST)
          echo "host=$IPV4_HOST" >> "$GITHUB_OUTPUT"

      - name: Run Migrations
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          DB_URL="postgres://postgres:${SUPABASE_DB_PASSWORD}@${{ steps.ipv4.outputs.host }}:5432/postgres"
          supabase db push --db-url "$DB_URL" 